@page "/"
@using GUI_Generator_UseCase1_Display.GeneratorInputs
@using GUI_Generator_UseCase1_Display.Helpers
@using GUI_Generator_UseCase1_Display.IndividualParts
@using GUI_Generator_UseCase1_Display.InitialExperiments
@using GUI_Generator_UseCase1_Display.Widgets
@using Models.Metadata
@using Models.UseCases.DisplayOnly.UseCase1
@using Radzen.Blazor
@using System.Reflection
@using System.Xml.Linq

<AdaptiveInterfaceRenderer DeviceModel="deviceModel" UserModel="userModel" InterfaceSpecification="interfaceSpecification"></AdaptiveInterfaceRenderer>

@code {
    private XmlConverter converter;
    private DeviceModel deviceModel;
    private InterfaceSpecification interfaceSpecification;
    private UserModel userModel;

    protected override void OnInitialized()
    {
        converter = new XmlConverter();
        var asm = Assembly.GetExecutingAssembly();
        var widgets = asm.GetTypes().GetDescendantElementsOfType<WidgetBase>().ToArray();

        var xml = BuildSpecification();
        var elementCollection = converter.TransformToElementCollection(xml);

        foreach (var item in elementCollection)
        {
            // Debugging
            Console.WriteLine(item.ElementType.StringRepresentation);    
        }

        interfaceSpecification = new InterfaceSpecification(elementCollection, null!);
        userModel = new UserModel();
        deviceModel = new DeviceModel(widgets, null!, HeuristicCalculator.CalculateWidgetScore);
    }

    private XElement BuildSpecification()
    {
        var avgTempElement = new XElement("AvgTemperature", new XAttribute("Type", "conditional"), new XAttribute("SubType", "float"), new XAttribute("Condition", "IsOn"));
        var avgPowerConsumptionelement = new XElement("AvgPowerConsumption", new XAttribute("Type", "conditional"), new XAttribute("SubType", "float"), new XAttribute("Condition", "IsOn"));
        var currentHumidityElement = new XElement("CurrentHumidity", new XAttribute("Type", "conditional"), new XAttribute("SubType", "float"), new XAttribute("Condition", "IsOn"));
        var currentTemperatureElement = new XElement("CurrentTemperature", new XAttribute("Type", "conditional"), new XAttribute("SubType", "float"), new XAttribute("Condition", "IsOn"));

        var hasPowerElement = new XElement("IsPoweredOn", new XAttribute("Type", "bool"));

        var rootElement = new XElement("Sensor", avgTempElement, avgPowerConsumptionelement, currentHumidityElement, currentTemperatureElement, hasPowerElement);

        return rootElement;
    }
}
